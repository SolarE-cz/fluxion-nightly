name: Promote to Production

on:
  workflow_dispatch:
    inputs:
      nightly_version:
        description: "Nightly version to promote (e.g., 0.1.5-nightly)"
        required: true
        type: string
      prod_version:
        description: "Production version (e.g., 0.2.0) - leave empty to auto-increment"
        required: false
        type: string

permissions:
  contents: read

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Validate nightly version format
        run: |
          NIGHTLY="${{ inputs.nightly_version }}"
          if [[ ! "$NIGHTLY" =~ -nightly$ ]]; then
            echo "❌ Error: Version must end with '-nightly'"
            echo "Example: 0.1.5-nightly"
            exit 1
          fi
          echo "✅ Valid nightly version: $NIGHTLY"

      - name: Prepare work directories
        run: |
          # Create unique work directory for this run
          WORK_DIR="/tmp/fluxion-promote-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          echo "WORK_DIR=$WORK_DIR" >> $GITHUB_ENV
          mkdir -p "$WORK_DIR"
          echo "✅ Work directory: $WORK_DIR"

      - name: Clone nightly repo
        run: |
          git clone --depth 1 --branch "${{ inputs.nightly_version }}" \
            https://github.com/SolarE-cz/fluxion-nightly.git "$WORK_DIR/nightly"
          
          echo "✅ Cloned nightly at version ${{ inputs.nightly_version }}"

      - name: Determine production version
        id: version
        run: |
          NIGHTLY="${{ inputs.nightly_version }}"
          
          if [ -n "${{ inputs.prod_version }}" ]; then
            # User specified prod version
            PROD_VERSION="${{ inputs.prod_version }}"
          else
            # Auto-increment: remove -nightly suffix
            PROD_VERSION=$(echo "$NIGHTLY" | sed 's/-nightly$//')
          fi
          
          echo "Production version: $PROD_VERSION"
          echo "version=$PROD_VERSION" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync ripgrep

      - name: Secret scan nightly snapshot
        run: |
          # Install trufflehog
          wget -q https://github.com/trufflesecurity/trufflehog/releases/latest/download/trufflehog_linux_amd64.tar.gz
          tar -xzf trufflehog_linux_amd64.tar.gz
          chmod +x trufflehog
          
          # Scan filesystem
          ./trufflehog filesystem "$WORK_DIR/nightly" --only-verified --fail

      - name: Validate nightly has required files
        run: |
          echo "Validating nightly snapshot..."
          REQUIRED_FILES=(
            "README.md"
            "fluxion/LICENSE"
            "fluxion/Cargo.toml"
            "fluxion/crates/fluxion-main/Cargo.toml"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$WORK_DIR/nightly/$file" ]; then
              echo "❌ ERROR: Required file missing: $file"
              exit 1
            fi
          done
          
          echo "✅ All required files present"

      - name: Load deploy key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.FLUXION_PROD_DEPLOY_KEY }}

      - name: Configure Git
        run: |
          git config --global user.name "FluxION CI"
          git config --global user.email "ci@solare.cz"

      - name: Add GitHub to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          echo "✅ GitHub added to known_hosts"

      - name: Clone prod repo
        run: |
          git clone --depth 1 git@github.com:SolarE-cz/fluxion.git "$WORK_DIR/prod"
          cd "$WORK_DIR/prod"
          git config user.name "FluxION CI"
          git config user.email "ci@solare.cz"

      - name: Sync and publish
        run: |
          # Sync nightly to prod (delete files not in nightly)
          rsync -a --delete --exclude='.git' "$WORK_DIR/nightly/" "$WORK_DIR/prod/"
          
          cd "$WORK_DIR/prod"
          
          # Always create commit (we're promoting a specific version)
          git add -A
          
          VERSION="${{ steps.version.outputs.version }}"
          NIGHTLY="${{ inputs.nightly_version }}"
          COMMIT_MSG="release: $VERSION (promoted from $NIGHTLY)"
          echo "$COMMIT_MSG"
          
          git commit -m "$COMMIT_MSG"
          
          # Create production tag
          git tag -a "v$VERSION" -m "Production release $VERSION"
          
          # Push commit and tag
          git push origin main
          git push origin "v$VERSION"
          
          echo "✅ Published production release: v$VERSION"

      - name: Cleanup
        if: always()
        run: |
          # Clean up work directory
          if [ -n "$WORK_DIR" ] && [ -d "$WORK_DIR" ]; then
            rm -rf "$WORK_DIR"
            echo "✅ Cleaned up work directory: $WORK_DIR"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ✅ Production Release Published" >> $GITHUB_STEP_SUMMARY
          echo "Repository: https://github.com/SolarE-cz/fluxion" >> $GITHUB_STEP_SUMMARY
          echo "Version: v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "Promoted from: ${{ inputs.nightly_version }}" >> $GITHUB_STEP_SUMMARY
