name: Promote to Production

on:
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  promote:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Validate ref is a tag (not a branch)
        run: |
          REF="${{ github.ref }}"
          if [[ ! "$REF" =~ ^refs/tags/ ]]; then
            echo "❌ ERROR: This workflow must be run on a tag, not a branch!"
            echo "Current ref: $REF"
            echo "Please select a tag (e.g., v0.2.14) when running this workflow."
            exit 1
          fi
          echo "✅ Running on tag: $REF"

      - name: Parse version from tag
        id: version
        run: |
          # Extract tag name from ref (refs/tags/v0.2.14 -> v0.2.14)
          TAG="${{ github.ref_name }}"
          # Remove 'v' prefix if present
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "✅ Promoting tag $TAG (version: $VERSION) to stable"

      - name: Checkout at tag (with full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history, not shallow clone

      - name: Validate fluxion-nightly directory exists
        run: |
          echo "Checking repository structure..."
          ls -la
          if [ ! -d "fluxion-nightly" ]; then
            echo "❌ ERROR: fluxion-nightly directory not found"
            echo "Directory contents:"
            ls -la
            exit 1
          fi
          echo "fluxion-nightly contents:"
          ls -la fluxion-nightly/

          # Check for the flat config.yaml path (at root of fluxion-nightly)
          if [ ! -f "fluxion-nightly/config.yaml" ]; then
            echo "❌ ERROR: fluxion-nightly/config.yaml not found"
            echo "Looking for config.yaml:"
            find fluxion-nightly -name "config.yaml" || echo "No config.yaml found"
            exit 1
          fi
          echo "✅ fluxion-nightly directory and config.yaml found"

      - name: Configure Git
        run: |
          git config user.name "FluxION CI"
          git config user.email "ci@solare.cz"

      - name: Copy nightly to stable directory and update config
        run: |
          set -e  # Exit on any error

          # Remove existing fluxion directory if it exists
          if [ -d "fluxion" ]; then
            echo "Removing existing fluxion directory..."
            rm -rf fluxion
          fi

          # Copy entire fluxion-nightly structure to fluxion (flat copy)
          echo "Copying fluxion-nightly to fluxion..."
          cp -r fluxion-nightly fluxion

          # Update config.yaml for stable version using sed
          echo "Updating config.yaml..."
          VERSION="${{ steps.version.outputs.version }}"
          REPO_URL="https://github.com/${{ github.repository }}"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_OWNER_LOWER=$(echo "$REPO_OWNER" | tr '[:upper:]' '[:lower:]')

          # Update the config.yaml fields
          sed -i "s/^name: .*/name: FluxION ECS/" fluxion/config.yaml
          sed -i "s/^slug: .*/slug: fluxion/" fluxion/config.yaml
          sed -i "s/^version: .*/version: \"$VERSION\"/" fluxion/config.yaml
          sed -i "s|^image: .*|image: \"ghcr.io/$REPO_OWNER_LOWER/fluxion-{arch}\"|" fluxion/config.yaml
          sed -i "s|^url: .*|url: \"$REPO_URL\"|" fluxion/config.yaml

          echo "✅ Created stable fluxion directory"

      - name: Verify stable config
        run: |
          echo "Verifying stable config.yaml..."
          if [ ! -f "fluxion/config.yaml" ]; then
            echo "❌ ERROR: fluxion/config.yaml not found after copy"
            echo "Checking fluxion structure:"
            find fluxion -name "config.yaml" || echo "No config.yaml found"
            exit 1
          fi
          cat fluxion/config.yaml
          echo "✅ Stable config verified"

      - name: Commit stable directory
        run: |
          git add fluxion

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          VERSION="${{ steps.version.outputs.version }}"
          COMMIT_MSG="release: Add stable addon for version $VERSION"

          git commit -m "$COMMIT_MSG"
          echo "✅ Created commit for stable addon"

      - name: Create stable tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Create stable tag with stable directory included
          git tag -a "v$VERSION-stable" -m "Stable release version $VERSION (includes stable addon)"

          # Push the commit and stable tag
          git push origin HEAD:main
          git push origin "v$VERSION-stable"

          echo "✅ Created stable tag v$VERSION-stable with stable addon"

      - name: Summary
        if: success()
        run: |
          echo "## ✅ Stable Addon Promoted" >> $GITHUB_STEP_SUMMARY
          echo "Repository: https://github.com/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "Promoted from nightly tag: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "Created stable tag: v${{ steps.version.outputs.version }}-stable" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Both addons are now available in Home Assistant:" >> $GITHUB_STEP_SUMMARY
          echo "- **FluxION ECS (Nightly)** - slug: fluxion-nightly" >> $GITHUB_STEP_SUMMARY
          echo "- **FluxION ECS** - slug: fluxion" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next: Docker images will be built in the build_stable job" >> $GITHUB_STEP_SUMMARY

  build_stable:
    needs: promote
    runs-on: ${{ matrix.arch == 'aarch64' && 'ubuntu-24.04-arm' || 'ubuntu-24.04' }}
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        arch: [aarch64, amd64]
    steps:
      - name: Checkout at stable tag
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.promote.outputs.version }}-stable

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get version
        id: version
        run: |
          VERSION="${{ needs.promote.outputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building stable version: $VERSION"

      - name: Map architecture
        id: arch
        run: |
          case ${{ matrix.arch }} in
            aarch64) echo "platform=linux/arm64" >> $GITHUB_OUTPUT ;;
            amd64) echo "platform=linux/amd64" >> $GITHUB_OUTPUT ;;
          esac

      - name: Downcase repo owner
        run: |
          echo "REPO_OWNER=${OWNER,,}" >> ${GITHUB_ENV}
        env:
          OWNER: '${{ github.repository_owner }}'

      - name: Build and push stable
        uses: docker/build-push-action@v5
        with:
          context: fluxion
          file: fluxion/Dockerfile
          platforms: ${{ steps.arch.outputs.platform }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPO_OWNER }}/fluxion-${{ matrix.arch }}:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.REPO_OWNER }}/fluxion-${{ matrix.arch }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build summary
        if: success()
        run: |
          echo "## ✅ Stable Docker Image Built" >> $GITHUB_STEP_SUMMARY
          echo "Architecture: ${{ matrix.arch }}" >> $GITHUB_STEP_SUMMARY
          echo "Image: ${{ env.REGISTRY }}/${{ env.REPO_OWNER }}/fluxion-${{ matrix.arch }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
