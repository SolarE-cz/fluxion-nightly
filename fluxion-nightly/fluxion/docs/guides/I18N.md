# Internationalization (i18n) Guide

FluxION-ECS supports multiple languages using [Mozilla's Fluent](https://projectfluent.org/)
framework. This document describes how the i18n system works and how to add or modify translations.

## Table of Contents

- [Overview](#overview)
- [Supported Languages](#supported-languages)
- [Architecture](#architecture)
- [Using Translations](#using-translations)
- [Adding a New Language](#adding-a-new-language)
- [Translation File Format](#translation-file-format)
- [Testing](#testing)

## Overview

The i18n system provides:

- **Multi-language support**: Currently Czech (cs) and English (en)
- **Variable interpolation**: Dynamic values (prices, counts, etc.)
- **Pluralization**: Correct plural forms for each language
- **Type safety**: Compile-time checks via integration tests
- **Fallback**: Graceful degradation to English

## Supported Languages

| Language | Code | Status | |----------|------|--------| | English | `en` | ✅ Complete (default) |
| Czech | `cs` | ✅ Complete |

## Architecture

### Directory Structure

```
crates/fluxion-i18n/
├── src/
│   └── lib.rs              # Core i18n implementation
├── locales/
│   ├── en/
│   │   ├── main.ftl        # Core translations
│   │   ├── web.ftl         # Web UI translations
│   │   └── schedule.ftl    # Schedule-related translations
│   └── cs/
│       ├── main.ftl
│       ├── web.ftl
│       └── schedule.ftl
└── tests/
    └── translation_tests.rs # Translation completeness tests
```

### Key Components

1. **`I18n` struct**: Main translation API
2. **`Language` enum**: Supported language codes
3. **`I18nResource`**: Bevy ECS Resource wrapper
4. **Fluent files (.ftl)**: Translation definitions

## Using Translations

### In Rust Code

```rust
use fluxion_i18n::{I18n, Language};
use fluent::fluent_args;

// Create i18n instance
let i18n = I18n::new(Language::Czech)?;

// Simple translation
let text = i18n.get("battery-soc")?;  // "Stav nabití"

// With variables
let text = i18n.format("reason-cheapest-block", Some(&fluent_args![
    "price" => 0.123,
    "currency" => "Kč"
]))?;  // "Nejlevnější blok (0.123 Kč/kWh)"
```

### In Bevy ECS Systems

```rust
use fluxion_core::resources::I18nResource;

fn my_system(i18n: Res<I18nResource>) {
    let text = i18n.inner().get("inverter-mode").unwrap();
    info!("Mode: {}", text);
}
```

### In Schedule Generation

```rust
use fluxion_core::scheduling::generate_schedule;

let schedule = generate_schedule(
    &time_block_prices,
    &analysis,
    &config,
    Some(&i18n_resource)  // Pass i18n for translated reasons
);
```

### In Web Templates (Askama)

```html
<h1>{{ self.t("dashboard-title") }}</h1>
<span>{{ self.t("battery-soc") }}: {{ soc }}{{ self.t("unit-percent") }}</span>
```

## Adding a New Language

### 1. Add Language to Enum

Edit `crates/fluxion-i18n/src/lib.rs`:

```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]
pub enum Language {
    English,
    Czech,
    German,  // Add new language
}

impl Language {
    pub fn code(&self) -> &'static str {
        match self {
            Self::English => "en",
            Self::Czech => "cs",
            Self::German => "de",  // Add code
        }
    }
    
    pub fn from_code(code: &str) -> Result<Self, I18nError> {
        match code.to_lowercase().as_str() {
            "en" | "english" => Ok(Self::English),
            "cs" | "czech" | "cz" => Ok(Self::Czech),
            "de" | "german" => Ok(Self::German),  // Add parser
            _ => Err(I18nError::UnsupportedLanguage(code.to_string())),
        }
    }
}
```

### 2. Create Translation Files

Create directory and files:

```bash
mkdir -p crates/fluxion-i18n/locales/de
touch crates/fluxion-i18n/locales/de/main.ftl
touch crates/fluxion-i18n/locales/de/web.ftl
touch crates/fluxion-i18n/locales/de/schedule.ftl
```

### 3. Update File Loader

Edit the `load_ftl_file` method in `lib.rs`:

```rust
fn load_ftl_file(lang_code: &str, domain: &str) -> Result<String, I18nError> {
    match (lang_code, domain) {
        ("en", "main") => Ok(include_str!("../locales/en/main.ftl").to_string()),
        // ... existing cases ...
        ("de", "main") => Ok(include_str!("../locales/de/main.ftl").to_string()),
        ("de", "web") => Ok(include_str!("../locales/de/web.ftl").to_string()),
        ("de", "schedule") => Ok(include_str!("../locales/de/schedule.ftl").to_string()),
        _ => Err(I18nError::LoadError(format!(
            "Translation file not found: {lang_code}/{domain}.ftl"
        ))),
    }
}
```

### 4. Add Translations

Copy English files as a starting point and translate all keys:

```bash
cp crates/fluxion-i18n/locales/en/*.ftl crates/fluxion-i18n/locales/de/
# Now edit the .ftl files and translate the content
```

### 5. Update Tests

Add the new language to `translation_tests.rs`:

```rust
#[test]
fn test_german_translations_complete() {
    use fluent::fluent_args;
    
    let i18n = I18n::new(Language::German).expect("Failed to load German translations");
    
    // ... test logic ...
}
```

## Translation File Format

Fluent uses `.ftl` files with a simple syntax:

### Simple Keys

```fluent
# Comment
key-name = Translation text
status-online = Online
```

### With Variables

```fluent
reason-cheapest-block = Cheapest block ({ $price } { $currency }/kWh)
```

Usage in Rust:

```rust
i18n.format("reason-cheapest-block", Some(&fluent_args![
    "price" => 0.123,
    "currency" => "Kč"
]))
```

### Pluralization

English (simple):

```fluent
time-in = In { $minutes ->
    [one] { $minutes } minute
   *[other] { $minutes } minutes
}
```

Czech (complex - one/few/other):

```fluent
time-in = Za { $minutes ->
    [one] { $minutes } minutu
    [few] { $minutes } minuty
   *[other] { $minutes } minut
}
```

### Multiline

```fluent
long-message = This is a long message
    that spans multiple lines.
    Each line is automatically joined.
```

### Attributes

```fluent
login-button = Sign in
    .aria-label = Sign in to your account
    .title = Click to sign in
```

## Translation Keys

All translation keys must follow kebab-case naming:

- `section-*`: UI section headings
- `battery-*`: Battery-related labels
- `grid-*`: Grid-related labels
- `pv-*`: Solar/PV-related labels
- `inverter-*`: Inverter-related labels
- `schedule-*`: Schedule-related labels
- `reason-*`: Schedule reason descriptions
- `status-*`: Status indicators
- `unit-*`: Measurement units
- `mode-*`: Operating modes

## Testing

### Run Translation Tests

```bash
cargo test -p fluxion-i18n
```

### Test Coverage

The test suite verifies:

- ✅ All 134 required keys exist in all languages
- ✅ No translations are empty
- ✅ Variable interpolation works correctly
- ✅ Pluralization works (especially Czech forms)
- ✅ Language switching produces different outputs

### Adding Tests for New Keys

When adding new translation keys, update `REQUIRED_KEYS` in `translation_tests.rs`:

```rust
const REQUIRED_KEYS: &[&str] = &[
    // ... existing keys ...
    "your-new-key",
];
```

## Configuration

### System Configuration

The language is set in `config.toml`:

```toml
[system]
language = "cs"  # or "en"
```

### Home Assistant Addon

Add to addon configuration schema:

```yaml
options:
  language:
    title: "Language / Jazyk"
    description: "User interface language"
    type: list
    default: "en"
    options:
      - value: "en"
        label: "English"
      - value: "cs"
        label: "Čeština"
```

## Best Practices

1. **Always provide both languages**: Never add a key to only one language
2. **Use descriptive keys**: `battery-soc` not `b-soc`
3. **Keep keys organized**: Group by domain (web, schedule, main)
4. **Test with real data**: Verify variables and plurals work correctly
5. **Handle missing translations**: Code should gracefully fallback to English
6. **Use proper pluralization**: Each language has different rules
7. **Keep translations concise**: UI space is limited
8. **Consider context**: "Bank" (financial) vs "Bank" (river) need different keys

## Common Pitfalls

### 1. Missing Variables

❌ **Wrong**:

```fluent
reason-cheapest-block = Cheapest block (Kč/kWh)
```

✅ **Correct**:

```fluent
reason-cheapest-block = Cheapest block ({ $price } { $currency }/kWh)
```

### 2. Incorrect Plural Forms

❌ **Wrong** (English rules applied to Czech):

```fluent
time-in = Za { $minutes ->
    [one] { $minutes } minuta
   *[other] { $minutes } minut
}
```

✅ **Correct** (Czech has three forms):

```fluent
time-in = Za { $minutes ->
    [one] { $minutes } minutu
    [few] { $minutes } minuty
   *[other] { $minutes } minut
}
```

### 3. Hardcoded Text

❌ **Wrong**:

```rust
format!("Battery SOC: {}%", soc)
```

✅ **Correct**:

```rust
format!("{}: {}{}", 
    i18n.get("battery-soc")?, 
    soc, 
    i18n.get("unit-percent")?
)
```

## Contributing Translations

To contribute a new language or fix translations:

1. Fork the repository
2. Add/modify translation files in `crates/fluxion-i18n/locales/`
3. Update `Language` enum and file loader
4. Add tests for the new language
5. Run tests: `cargo test -p fluxion-i18n`
6. Submit a pull request

## Resources

- [Fluent Syntax Guide](https://projectfluent.org/fluent/guide/)
- [Fluent Playground](https://projectfluent.org/play/)
- [Unicode CLDR Plurals](https://cldr.unicode.org/index/cldr-spec/plural-rules)
- [Czech Pluralization Rules](https://unicode-org.github.io/cldr-staging/charts/latest/supplemental/language_plural_rules.html#cs)

## Support

For questions or issues:

- Open an issue on GitHub
- Check existing translations in `locales/` for examples
- Run tests to verify your changes work correctly
