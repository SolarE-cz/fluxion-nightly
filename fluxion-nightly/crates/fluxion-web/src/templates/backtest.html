{% extends "base.html" %}

{% block title %}FluxION Backtest{% endblock %}

{% block content %}
<style>
    /* Backtest-specific styles */
    .backtest-header {
        background: var(--bg-secondary);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .backtest-header h1 {
        font-size: 1.6em;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .nav-buttons {
        display: flex;
        gap: 10px;
    }

    .day-selector {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .day-selector select {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 1em;
        cursor: pointer;
        min-width: 180px;
    }

    .comparison-bar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 15px 25px;
        border-radius: 8px;
        text-align: center;
        font-size: 1.1em;
        font-weight: 600;
        margin-bottom: 20px;
    }

    .twin-view {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    @media (max-width: 1200px) {
        .twin-view {
            grid-template-columns: 1fr;
        }
    }

    .panel {
        background: var(--bg-secondary);
        border-radius: 8px;
        overflow: hidden;
    }

    .panel-header {
        background: var(--bg-tertiary);
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .panel-title {
        font-weight: 600;
        font-size: 1.1em;
    }

    .strategy-select {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.95em;
        cursor: pointer;
        min-width: 160px;
    }

    .panel-body {
        padding: 20px;
    }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }

    .summary-card {
        background: var(--bg-tertiary);
        padding: 15px;
        border-radius: 6px;
        text-align: center;
    }

    .summary-card-label {
        font-size: 0.85em;
        color: var(--text-secondary);
        margin-bottom: 5px;
    }

    .summary-card-value {
        font-size: 1.4em;
        font-weight: 700;
    }

    .summary-card-value.positive {
        color: var(--success);
    }

    .summary-card-value.negative {
        color: var(--error);
    }

    .energy-table {
        width: 100%;
        font-size: 0.9em;
    }

    .energy-table tr {
        border-bottom: 1px solid var(--border-color);
    }

    .energy-table td {
        padding: 8px 0;
    }

    .energy-table td:first-child {
        color: var(--text-secondary);
    }

    .energy-table td:last-child {
        text-align: right;
        font-weight: 600;
    }

    .params-toggle {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85em;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .params-panel {
        background: var(--bg-primary);
        padding: 15px;
        border-radius: 6px;
        margin-top: 15px;
        display: none;
    }

    .params-panel.active {
        display: block;
    }

    .param-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .param-label {
        font-size: 0.9em;
        color: var(--text-secondary);
    }

    .param-input {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 6px 10px;
        border-radius: 4px;
        width: 80px;
        text-align: right;
    }

    .reset-btn {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85em;
        width: 100%;
        margin-top: 10px;
    }

    .reset-btn:hover {
        background: var(--border-color);
    }

    .chart-section {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .chart-title {
        font-size: 1.1em;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .combined-chart-container {
        height: 400px;
        position: relative;
    }

    .mode-timeline {
        margin-top: 20px;
    }

    .timeline-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }

    .timeline-label {
        min-width: 60px;
        font-size: 0.85em;
        color: var(--text-secondary);
    }

    .timeline-bar {
        flex: 1;
        height: 24px;
        display: flex;
        border-radius: 4px;
        overflow: hidden;
    }

    .timeline-segment {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7em;
        font-weight: 600;
        color: #fff;
    }

    .timeline-segment.charge { background: var(--warning); color: #000; }
    .timeline-segment.discharge { background: var(--success); }
    .timeline-segment.selfuse { background: var(--info); }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        z-index: 100;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-color);
        border-top-color: var(--info);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .hidden {
        display: none !important;
    }
</style>

<div class="container">
    <!-- Header -->
    <div class="backtest-header">
        <h1>
            <i class="mdi mdi-chart-timeline-variant"></i>
            Strategy Backtesting
        </h1>

        <div class="day-selector">
            <label>Day:</label>
            <select id="day-select">
                {% for day in available_days %}
                <option value="{{ day }}">{{ day }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="nav-buttons">
            <a href="{{ ingress_path }}/" class="config-button">
                <i class="mdi mdi-view-dashboard"></i>
                Dashboard
            </a>
        </div>
    </div>

    <!-- Comparison Bar -->
    <div class="comparison-bar" id="comparison-bar">
        Select strategies to compare
    </div>

    <!-- Twin View -->
    <div class="twin-view">
        <!-- Left Panel -->
        <div class="panel" id="left-panel">
            <div class="panel-header">
                <span class="panel-title">Left Panel</span>
                <select class="strategy-select" id="left-strategy">
                    {% for strategy in strategies %}
                    <option value="{{ strategy.id }}"{% if strategy.id == "actual" %} selected{% endif %}>
                        {{ strategy.name }}
                    </option>
                    {% endfor %}
                </select>
                <button class="params-toggle" id="left-params-toggle" style="display: none;">
                    <i class="mdi mdi-tune"></i>
                    Parameters
                </button>
            </div>
            <div class="panel-body">
                <div class="params-panel" id="left-params-panel">
                    <div class="param-row">
                        <span class="param-label">Target SOC (%)</span>
                        <input type="number" class="param-input" id="left-target-soc" value="90" min="50" max="100">
                    </div>
                    <div class="param-row">
                        <span class="param-label">Top Blocks</span>
                        <input type="number" class="param-input" id="left-top-blocks" value="12" min="1" max="24">
                    </div>
                    <div class="param-row">
                        <span class="param-label">Safety Mult.</span>
                        <input type="number" class="param-input" id="left-safety-mult" value="1.3" min="1.0" max="2.0" step="0.1">
                    </div>
                    <button class="reset-btn" id="left-reset-params">Reset to Defaults</button>
                </div>

                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="summary-card-label">Net Cost</div>
                        <div class="summary-card-value" id="left-net-cost">--</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-label">Battery Value</div>
                        <div class="summary-card-value" id="left-battery-value">--</div>
                    </div>
                </div>

                <table class="energy-table">
                    <tr><td>PV Generation</td><td id="left-pv">-- kWh</td></tr>
                    <tr><td>Grid Import</td><td id="left-import">-- kWh</td></tr>
                    <tr><td>Grid Export</td><td id="left-export">-- kWh</td></tr>
                    <tr><td>Battery Charge</td><td id="left-charge">-- kWh</td></tr>
                    <tr><td>Battery Discharge</td><td id="left-discharge">-- kWh</td></tr>
                    <tr><td>Consumption</td><td id="left-consumption">-- kWh</td></tr>
                </table>
            </div>
            <div class="loading-overlay hidden" id="left-loading">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="panel" id="right-panel">
            <div class="panel-header">
                <span class="panel-title">Right Panel</span>
                <select class="strategy-select" id="right-strategy">
                    {% for strategy in strategies %}
                    <option value="{{ strategy.id }}"{% if strategy.id == "winter_adaptive" %} selected{% endif %}>
                        {{ strategy.name }}
                    </option>
                    {% endfor %}
                </select>
                <button class="params-toggle" id="right-params-toggle">
                    <i class="mdi mdi-tune"></i>
                    Parameters
                </button>
            </div>
            <div class="panel-body">
                <div class="params-panel" id="right-params-panel">
                    <div class="param-row">
                        <span class="param-label">Target SOC (%)</span>
                        <input type="number" class="param-input" id="right-target-soc" value="90" min="50" max="100">
                    </div>
                    <div class="param-row">
                        <span class="param-label">Top Blocks</span>
                        <input type="number" class="param-input" id="right-top-blocks" value="12" min="1" max="24">
                    </div>
                    <div class="param-row">
                        <span class="param-label">Safety Mult.</span>
                        <input type="number" class="param-input" id="right-safety-mult" value="1.3" min="1.0" max="2.0" step="0.1">
                    </div>
                    <button class="reset-btn" id="right-reset-params">Reset to Defaults</button>
                </div>

                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="summary-card-label">Net Cost</div>
                        <div class="summary-card-value" id="right-net-cost">--</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-label">Battery Value</div>
                        <div class="summary-card-value" id="right-battery-value">--</div>
                    </div>
                </div>

                <table class="energy-table">
                    <tr><td>PV Generation</td><td id="right-pv">-- kWh</td></tr>
                    <tr><td>Grid Import</td><td id="right-import">-- kWh</td></tr>
                    <tr><td>Grid Export</td><td id="right-export">-- kWh</td></tr>
                    <tr><td>Battery Charge</td><td id="right-charge">-- kWh</td></tr>
                    <tr><td>Battery Discharge</td><td id="right-discharge">-- kWh</td></tr>
                    <tr><td>Consumption</td><td id="right-consumption">-- kWh</td></tr>
                </table>
            </div>
            <div class="loading-overlay hidden" id="right-loading">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <!-- Combined Chart -->
    <div class="chart-section">
        <div class="chart-title">Price & SOC Comparison</div>
        <div class="combined-chart-container">
            <canvas id="comparison-chart"></canvas>
        </div>

        <div class="mode-timeline">
            <div class="timeline-row">
                <span class="timeline-label">Left:</span>
                <div class="timeline-bar" id="left-timeline"></div>
            </div>
            <div class="timeline-row">
                <span class="timeline-label">Right:</span>
                <div class="timeline-bar" id="right-timeline"></div>
            </div>
        </div>
    </div>
</div>

<script>
// Backtest application state
const state = {
    selectedDay: '{{ available_days.first().unwrap_or(&"".to_string()) }}',
    left: { strategy: 'actual', data: null, overrides: null },
    right: { strategy: 'winter_adaptive', data: null, overrides: null },
    chart: null
};

// API functions
const api = {
    baseUrl: '{{ ingress_path }}',

    async getDayData(date) {
        const response = await fetch(`${this.baseUrl}/api/backtest/day/${date}`);
        if (!response.ok) throw new Error('Failed to fetch day data');
        return response.json();
    },

    async simulate(date, strategy, overrides) {
        const response = await fetch(`${this.baseUrl}/api/backtest/simulate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date, strategy, config_overrides: overrides })
        });
        if (!response.ok) throw new Error('Simulation failed');
        return response.json();
    }
};

// UI update functions
function updatePanel(side, data) {
    const prefix = side;

    document.getElementById(`${prefix}-net-cost`).textContent = `${data.net_cost_czk.toFixed(0)} CZK`;
    document.getElementById(`${prefix}-battery-value`).textContent = `${data.battery_value_czk.toFixed(0)} CZK`;

    document.getElementById(`${prefix}-pv`).textContent = `${data.pv_generation_kwh.toFixed(1)} kWh`;
    document.getElementById(`${prefix}-import`).textContent = `${data.grid_import_kwh.toFixed(1)} kWh`;
    document.getElementById(`${prefix}-export`).textContent = `${data.grid_export_kwh.toFixed(1)} kWh`;
    document.getElementById(`${prefix}-charge`).textContent = `${data.battery_charge_kwh.toFixed(1)} kWh`;
    document.getElementById(`${prefix}-discharge`).textContent = `${data.battery_discharge_kwh.toFixed(1)} kWh`;
    document.getElementById(`${prefix}-consumption`).textContent = `${data.consumption_kwh.toFixed(1)} kWh`;

    // Color code net cost
    const netCostEl = document.getElementById(`${prefix}-net-cost`);
    netCostEl.classList.remove('positive', 'negative');
    if (data.net_cost_czk < 0) netCostEl.classList.add('positive');
}

function updateComparisonBar() {
    const bar = document.getElementById('comparison-bar');

    if (!state.left.data || !state.right.data) {
        bar.textContent = 'Select strategies to compare';
        return;
    }

    const diff = state.right.data.net_cost_czk - state.left.data.net_cost_czk;
    const savingsPercent = state.left.data.net_cost_czk !== 0
        ? ((state.left.data.net_cost_czk - state.right.data.net_cost_czk) / Math.abs(state.left.data.net_cost_czk)) * 100
        : 0;

    if (diff < 0) {
        bar.textContent = `Right (${state.right.data.strategy}) saves ${Math.abs(diff).toFixed(0)} CZK (${savingsPercent.toFixed(1)}%) vs Left`;
        bar.style.background = 'linear-gradient(135deg, #4caf50 0%, #2e7d32 100%)';
    } else if (diff > 0) {
        bar.textContent = `Left (${state.left.data.strategy}) saves ${diff.toFixed(0)} CZK (${Math.abs(savingsPercent).toFixed(1)}%) vs Right`;
        bar.style.background = 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)';
    } else {
        bar.textContent = `Both strategies have equal costs`;
        bar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    }
}

function updateChart() {
    const ctx = document.getElementById('comparison-chart');

    // Destroy existing chart
    if (state.chart) {
        state.chart.destroy();
    }

    if (!state.left.data || !state.right.data) return;

    // Prepare data
    const leftData = state.left.data.hourly_data;
    const rightData = state.right.data.hourly_data;

    // Use left data timestamps as labels
    const labels = leftData.map(d => {
        const date = new Date(d.timestamp);
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
    });

    // Prices (same for both)
    const prices = leftData.map(d => d.price_czk);

    // SOC data
    const leftSoc = leftData.map(d => d.soc_percent);
    const rightSoc = rightData.map(d => d.soc_percent);

    state.chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Price (CZK/kWh)',
                    data: prices,
                    borderColor: 'rgba(255, 215, 0, 0.8)',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    yAxisID: 'y-price',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0
                },
                {
                    label: `Left SOC (${state.left.data.strategy})`,
                    data: leftSoc,
                    borderColor: 'rgba(33, 150, 243, 1)',
                    backgroundColor: 'transparent',
                    yAxisID: 'y-soc',
                    borderWidth: 2,
                    tension: 0.2,
                    pointRadius: 0
                },
                {
                    label: `Right SOC (${state.right.data.strategy})`,
                    data: rightSoc,
                    borderColor: 'rgba(76, 175, 80, 1)',
                    backgroundColor: 'transparent',
                    yAxisID: 'y-soc',
                    borderWidth: 2,
                    tension: 0.2,
                    pointRadius: 0,
                    borderDash: [5, 5]
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: '#e0e0e0' }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#e0e0e0'
                }
            },
            scales: {
                'y-price': {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Price (CZK/kWh)', color: '#ffd700' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { color: '#ffd700' }
                },
                'y-soc': {
                    type: 'linear',
                    position: 'right',
                    min: 0,
                    max: 100,
                    title: { display: true, text: 'SOC (%)', color: '#e0e0e0' },
                    grid: { display: false },
                    ticks: { color: '#e0e0e0' }
                },
                x: {
                    ticks: {
                        color: '#999',
                        maxRotation: 45,
                        autoSkip: true,
                        maxTicksLimit: 24
                    },
                    grid: { display: false }
                }
            }
        }
    });
}

function updateTimeline(side, data) {
    const timeline = document.getElementById(`${side}-timeline`);
    if (!data || !data.hourly_data || data.hourly_data.length === 0) {
        timeline.innerHTML = '';
        return;
    }

    // Group consecutive modes
    const segments = [];
    let currentMode = null;
    let currentCount = 0;

    data.hourly_data.forEach(point => {
        const mode = point.mode.toLowerCase().replace(/[^a-z]/g, '');
        if (mode === currentMode) {
            currentCount++;
        } else {
            if (currentMode) {
                segments.push({ mode: currentMode, count: currentCount });
            }
            currentMode = mode;
            currentCount = 1;
        }
    });
    if (currentMode) {
        segments.push({ mode: currentMode, count: currentCount });
    }

    const total = data.hourly_data.length;
    timeline.innerHTML = segments.map(seg => {
        const width = (seg.count / total) * 100;
        let className = 'selfuse';
        let label = 'SU';

        if (seg.mode.includes('charge') && !seg.mode.includes('discharge')) {
            className = 'charge';
            label = 'CHG';
        } else if (seg.mode.includes('discharge')) {
            className = 'discharge';
            label = 'DIS';
        }

        return `<div class="timeline-segment ${className}" style="width: ${width}%">${width > 5 ? label : ''}</div>`;
    }).join('');
}

// Data loading functions
async function loadPanelData(side) {
    const strategy = state[side].strategy;
    const loadingEl = document.getElementById(`${side}-loading`);

    try {
        loadingEl.classList.remove('hidden');

        let data;
        if (strategy === 'actual') {
            data = await api.getDayData(state.selectedDay);
        } else {
            const overrides = getOverrides(side);
            data = await api.simulate(state.selectedDay, strategy, overrides);
        }

        state[side].data = data;
        updatePanel(side, data);
        updateTimeline(side, data);
        updateComparisonBar();
        updateChart();
    } catch (error) {
        console.error(`Error loading ${side} panel:`, error);
        alert(`Failed to load data: ${error.message}`);
    } finally {
        loadingEl.classList.add('hidden');
    }
}

function getOverrides(side) {
    const strategy = state[side].strategy;
    if (strategy === 'actual' || strategy === 'self_use') return null;

    return {
        daily_charging_target_soc: parseFloat(document.getElementById(`${side}-target-soc`).value),
        top_expensive_blocks: parseInt(document.getElementById(`${side}-top-blocks`).value),
        charge_safety_multiplier: parseFloat(document.getElementById(`${side}-safety-mult`).value)
    };
}

// Event listeners
document.getElementById('day-select').addEventListener('change', async (e) => {
    state.selectedDay = e.target.value;
    await Promise.all([loadPanelData('left'), loadPanelData('right')]);
});

['left', 'right'].forEach(side => {
    document.getElementById(`${side}-strategy`).addEventListener('change', async (e) => {
        state[side].strategy = e.target.value;

        // Show/hide params toggle
        const hasParams = e.target.value === 'winter_adaptive';
        document.getElementById(`${side}-params-toggle`).style.display = hasParams ? 'flex' : 'none';

        await loadPanelData(side);
    });

    document.getElementById(`${side}-params-toggle`).addEventListener('click', () => {
        const panel = document.getElementById(`${side}-params-panel`);
        panel.classList.toggle('active');
    });

    document.getElementById(`${side}-reset-params`).addEventListener('click', () => {
        document.getElementById(`${side}-target-soc`).value = '90';
        document.getElementById(`${side}-top-blocks`).value = '12';
        document.getElementById(`${side}-safety-mult`).value = '1.3';
        loadPanelData(side);
    });

    // Parameter change listeners
    ['target-soc', 'top-blocks', 'safety-mult'].forEach(param => {
        document.getElementById(`${side}-${param}`).addEventListener('change', () => {
            if (state[side].strategy !== 'actual' && state[side].strategy !== 'self_use') {
                loadPanelData(side);
            }
        });
    });
});

// Initial load
document.addEventListener('DOMContentLoaded', async () => {
    if (state.selectedDay) {
        await Promise.all([loadPanelData('left'), loadPanelData('right')]);
    }
});
</script>
{% endblock %}
